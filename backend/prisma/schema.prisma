generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model TipoAusencia {
  idTipoAusencia     Int          @id @default(autoincrement()) @map("id_tipo_ausencia")
  codigo             String       @unique @db.VarChar(5)
  descricao          String       @db.VarChar(200)
  impactaAbsenteismo Boolean      @default(true) @map("impacta_absenteismo")
  justificada        Boolean      @default(true)
  requerDocumento    Boolean      @default(false) @map("requer_documento")
  ativo              Boolean      @default(true)
  dataCriacao        DateTime     @default(now()) @map("data_criacao")
  ausencias          Ausencia[]
  frequencias        Frequencia[]

  @@map("tipo_ausencia")
}

model Frequencia {
  idFrequencia     Int       @id @default(autoincrement()) @map("id_frequencia")
  opsId            String    @map("ops_id") @db.VarChar(50)
  dataReferencia   DateTime  @map("data_referencia") @db.Date
  idTipoAusencia   Int?      @map("id_tipo_ausencia")
  idSetor          Int?      @map("id_setor")
  horaEntrada      DateTime? @map("hora_entrada") @db.Time(6)
  horaSaida        DateTime? @map("hora_saida") @db.Time(6)
  horasTrabalhadas Decimal?  @map("horas_trabalhadas") @db.Decimal(4, 2)
  observacao       String?
  manual           Boolean   @default(false)
  justificativa    String?
  documentoAnexo   String?   @map("documento_anexo") @db.VarChar(500)
  dataRegistro     DateTime  @default(now()) @map("data_registro")
  registradoPor    String?   @map("registrado_por") @db.VarChar(50)
  validado         Boolean   @default(false)
  validadoPor      String?   @map("validado_por") @db.VarChar(50)
  dataValidacao    DateTime? @map("data_validacao")

  tipoAusencia TipoAusencia?         @relation(fields: [idTipoAusencia], references: [idTipoAusencia])
  colaborador  Colaborador           @relation(fields: [opsId], references: [opsId])
  setor        Setor?                @relation(fields: [idSetor], references: [idSetor])
  historico    FrequenciaHistorico[]

  @@unique([opsId, dataReferencia])
  @@index([opsId])
  @@index([dataReferencia])
  @@index([idTipoAusencia])
  @@index([idSetor])
  @@index([dataReferencia, idSetor])
  @@map("frequencia")
}

model Ausencia {
  idAusencia          Int            @id @default(autoincrement()) @map("id_ausencia")
  opsId               String         @map("ops_id") @db.VarChar(50)
  idTipoAusencia      Int            @map("id_tipo_ausencia")
  dataInicio          DateTime       @map("data_inicio") @db.Date
  dataFim             DateTime       @map("data_fim") @db.Date
  dataPrevistaRetorno DateTime?      @map("data_prevista_retorno") @db.Date
  diasCorridos        Int?           @map("dias_corridos")
  diasUteis           Int?           @map("dias_uteis")
  motivo              String?
  documentoAnexo      String?        @map("documento_anexo") @db.VarChar(500)
  numeroProtocolo     String?        @map("numero_protocolo") @db.VarChar(100)
  status              StatusAusencia @default(ATIVO)
  dataRegistro        DateTime       @default(now()) @map("data_registro")
  registradoPor       String?        @map("registrado_por") @db.VarChar(50)
  dataAtualizacao     DateTime       @default(now()) @updatedAt @map("data_atualizacao")
  tipoAusencia        TipoAusencia   @relation(fields: [idTipoAusencia], references: [idTipoAusencia])
  colaborador         Colaborador    @relation(fields: [opsId], references: [opsId])

  @@index([opsId])
  @@index([dataInicio, dataFim])
  @@index([status])
  @@map("ausencia")
}

model HistoricoMovimentacao {
  idHistorico      Int         @id @default(autoincrement()) @map("id_historico")
  opsId            String      @map("ops_id") @db.VarChar(50)
  tipoMovimentacao String      @map("tipo_movimentacao") @db.VarChar(50)
  setorAnterior    Int?        @map("setor_anterior")
  cargoAnterior    Int?        @map("cargo_anterior")
  estacaoAnterior  Int?        @map("estacao_anterior")
  turnoAnterior    Int?        @map("turno_anterior")
  liderAnterior    String?     @map("lider_anterior") @db.VarChar(50)
  setorNovo        Int?        @map("setor_novo")
  cargoNovo        Int?        @map("cargo_novo")
  estacaoNova      Int?        @map("estacao_nova")
  turnoNovo        Int?        @map("turno_novo")
  liderNovo        String?     @map("lider_novo") @db.VarChar(50)
  dataEfetivacao   DateTime    @map("data_efetivacao") @db.Date
  motivo           String?
  registradoPor    String?     @map("registrado_por") @db.VarChar(50)
  colaborador      Colaborador @relation("ColaboradorMovimentado", fields: [opsId], references: [opsId])

  @@index([opsId])
  @@index([dataEfetivacao])
  @@map("historico_movimentacao")
}

model User {
  id        String   @id @default(uuid())
  name      String
  email     String   @unique
  password  String
  role      UserRole @default(OPERACAO)
  avatar    String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  opsId     String?  @map("ops_id") @db.VarChar(50)

  @@map("users")
}

model Empresa {
  idEmpresa       Int            @id @default(autoincrement()) @map("id_empresa")
  razaoSocial     String         @unique @map("razao_social") @db.VarChar(200)
  cnpj            String?        @unique @db.VarChar(18)
  ativo           Boolean        @default(true)
  dataCriacao     DateTime       @default(now()) @map("data_criacao")
  dataAtualizacao DateTime       @default(now()) @updatedAt @map("data_atualizacao")
  colaboradores   Colaborador[]
  contratos       Contrato[]
  desligamentos   Desligamento[]

  @@map("empresa")
}

model Setor {
  idSetor     Int      @id @default(autoincrement()) @map("id_setor")
  nomeSetor   String   @unique @map("nome_setor") @db.VarChar(100)
  descricao   String?
  ativo       Boolean  @default(true)
  dataCriacao DateTime @default(now()) @map("data_criacao")

  colaboradores Colaborador[]
  frequencias   Frequencia[]
  treinamentos  TreinamentoSetor[]

  @@map("setor")
}

model Cargo {
  idCargo       Int           @id @default(autoincrement()) @map("id_cargo")
  nomeCargo     String        @unique @map("nome_cargo") @db.VarChar(100)
  nivel         String?       @db.VarChar(50)
  descricao     String?
  ativo         Boolean       @default(true)
  dataCriacao   DateTime      @default(now()) @map("data_criacao")
  colaboradores Colaborador[]

  @@map("cargo")
}

model Estacao {
  idEstacao     Int           @id @default(autoincrement()) @map("id_estacao")
  nomeEstacao   String        @unique @map("nome_estacao") @db.VarChar(100)
  localizacao   String?       @db.VarChar(200)
  capacidade    Int?
  ativo         Boolean       @default(true)
  dataCriacao   DateTime      @default(now()) @map("data_criacao")
  idRegional    Int?          @map("id_regional")
  regional      Regional?     @relation(fields: [idRegional], references: [idRegional])
  colaboradores Colaborador[]

  @@index([idRegional])
  @@map("estacao")
}

model Escala {
  idEscala        Int           @id @default(autoincrement()) @map("id_escala")
  nomeEscala      String        @unique @map("nome_escala") @db.VarChar(100)
  tipoEscala      String?       @map("tipo_escala") @db.VarChar(50)
  diasTrabalhados Int?          @map("dias_trabalhados")
  diasFolga       Int?          @map("dias_folga")
  descricao       String?
  ativo           Boolean       @default(true)
  dataCriacao     DateTime      @default(now()) @map("data_criacao")
  colaboradores   Colaborador[]

  @@map("escala")
}

model Turno {
  idTurno       Int           @id @default(autoincrement()) @map("id_turno")
  nomeTurno     String        @unique @map("nome_turno") @db.VarChar(50)
  horarioInicio DateTime      @map("horario_inicio") @db.Time(6)
  horarioFim    DateTime      @map("horario_fim") @db.Time(6)
  ativo         Boolean       @default(true)
  dataCriacao   DateTime      @default(now()) @map("data_criacao")
  colaboradores Colaborador[]

  @@map("turno")
}

model Contrato {
  idContrato    Int           @id @default(autoincrement()) @map("id_contrato")
  nomeContrato  String        @map("nome_contrato") @db.VarChar(100)
  idEmpresa     Int?          @map("id_empresa")
  dataInicio    DateTime?     @map("data_inicio") @db.Date
  dataFim       DateTime?     @map("data_fim") @db.Date
  ativo         Boolean       @default(true)
  dataCriacao   DateTime      @default(now()) @map("data_criacao")
  colaboradores Colaborador[]
  empresa       Empresa?      @relation(fields: [idEmpresa], references: [idEmpresa])

  @@map("contrato")
}

model Colaborador {
  opsId                  String                    @id @map("ops_id") @db.VarChar(50)
  nomeCompleto           String                    @map("nome_completo") @db.VarChar(200)
  genero                 String?                   @db.VarChar(20)
  matricula              String                    @unique @db.VarChar(50)
  dataAdmissao           DateTime                  @map("data_admissao") @db.Date
  dataDesligamento       DateTime?                 @map("data_desligamento") @db.Date
  horarioInicioJornada   DateTime                  @map("horario_inicio_jornada") @db.Time(6)
  primeiroDiaPosDsr      DateTime?                 @map("primeiro_dia_pos_dsr") @db.Date
  contatoEmergenciaNome        String? @map("contato_emergencia_nome") @db.VarChar(200)
  contatoEmergenciaTelefone    String? @map("contato_emergencia_telefone") @db.VarChar(20)
  idSetor                Int?                      @map("id_setor")
  idCargo                Int?                      @map("id_cargo")
  idLider                String?                   @map("id_lider") @db.VarChar(50)
  idEstacao              Int?                      @map("id_estacao")
  idEmpresa              Int?                      @map("id_empresa")
  idContrato             Int?                      @map("id_contrato")
  idEscala               Int?                      @map("id_escala")
  idTurno                Int?                      @map("id_turno")
  status                 StatusColaborador         @default(ATIVO)
  dataCriacao            DateTime                  @default(now()) @map("data_criacao")
  dataAtualizacao        DateTime                  @default(now()) @updatedAt @map("data_atualizacao")
  cpf                    String?                   @db.VarChar(14)
  dataNascimento         DateTime?                 @map("data_nascimento")
  email                  String?                   @unique @db.VarChar(200)
  telefone               String?                   @db.VarChar(20)
  acidentes              AcidenteTrabalho[]
  atestadosMedicos       AtestadoMedico[]
  ausencias              Ausencia[]
  cargo                  Cargo?                    @relation(fields: [idCargo], references: [idCargo])
  contrato               Contrato?                 @relation(fields: [idContrato], references: [idContrato])
  empresa                Empresa?                  @relation(fields: [idEmpresa], references: [idEmpresa])
  escala                 Escala?                   @relation(fields: [idEscala], references: [idEscala])
  estacao                Estacao?                  @relation(fields: [idEstacao], references: [idEstacao])
  lider                  Colaborador?              @relation("LiderSubordinado", fields: [idLider], references: [opsId])
  subordinados           Colaborador[]             @relation("LiderSubordinado")
  setor                  Setor?                    @relation(fields: [idSetor], references: [idSetor])
  turno                  Turno?                    @relation(fields: [idTurno], references: [idTurno])
  frequencias            Frequencia[]
  historicoMovimentacao  HistoricoMovimentacao[]   @relation("ColaboradorMovimentado")
  medidasDisciplinares   MedidaDisciplinar[]
  desligamentos          Desligamento[]
  treinamentosLiderados  Treinamento[]             @relation("TreinamentoLider")
  treinamentosParticipou TreinamentoParticipante[]

  @@index([matricula])
  @@index([status])
  @@index([idSetor])
  @@index([idLider])
  @@index([dataAdmissao])
  @@map("colaborador")
}

model AtestadoMedico {
  idAtestado      Int            @id @default(autoincrement()) @map("id_atestado")
  opsId           String         @map("ops_id") @db.VarChar(50)
  dataInicio      DateTime       @map("data_inicio") @db.Date
  dataFim         DateTime       @map("data_fim") @db.Date
  diasAfastamento Int            @map("dias_afastamento")
  cid             String?        @db.VarChar(10)
  observacao      String?
  documentoAnexo  String?        @map("documento_anexo") @db.VarChar(500)
  status          StatusAtestado @default(ATIVO)
  dataRegistro    DateTime       @default(now()) @map("data_registro")
  colaborador     Colaborador    @relation(fields: [opsId], references: [opsId])

  @@index([opsId])
  @@index([dataInicio, dataFim])
  @@map("atestado_medico")
}

model MedidaDisciplinar {
  idMedida       Int         @id @default(autoincrement()) @map("id_medida")
  opsId          String      @map("ops_id")
  dataAplicacao  DateTime    @map("data_aplicacao")
  tipoMedida     String      @map("tipo_medida")
  motivo         String
  documentoAnexo String      @map("documento_anexo")
  dataRegistro   DateTime    @default(now()) @map("data_registro")
  colaborador    Colaborador @relation(fields: [opsId], references: [opsId])

  @@map("medida_disciplinar")
}

model AcidenteTrabalho {
  idAcidente           Int                 @id @default(autoincrement())
  opsIdColaborador     String
  registradoPor        String
  setor                String
  cargo                String
  participouIntegracao Boolean
  tipoOcorrencia       String
  dataOcorrencia       DateTime
  horarioOcorrencia    DateTime
  dataComunicacaoHSE   DateTime
  localOcorrencia      String
  situacaoGeradora     String
  agenteCausador       String
  parteCorpoAtingida   String
  lateralidade         String
  tipoLesao            String
  acoesImediatas       String
  createdAt            DateTime            @default(now())
  colaborador          Colaborador         @relation(fields: [opsIdColaborador], references: [opsId])
  evidencias           EvidenciaAcidente[]
}

model EvidenciaAcidente {
  idEvidencia Int              @id @default(autoincrement())
  idAcidente  Int
  arquivoUrl  String
  createdAt   DateTime         @default(now())
  acidente    AcidenteTrabalho @relation(fields: [idAcidente], references: [idAcidente])
}

model FrequenciaHistorico {
  idFrequenciaHistorico Int      @id @default(autoincrement()) @map("id_frequencia_historico")
  idFrequencia          Int      @map("id_frequencia")
  statusAnterior        String?  @map("status_anterior")
  statusNovo            String?  @map("status_novo")
  justificativa         String?
  alteradoPor           String?  @map("alterado_por")
  dataAlteracao         DateTime @default(now()) @map("data_alteracao")

  frequencia Frequencia @relation(fields: [idFrequencia], references: [idFrequencia])

  @@index([idFrequencia])
  @@map("frequencia_historico")
}

model Desligamento {
  idDesligamento   Int                @id @default(autoincrement())
  opsId            String             @map("ops_id") @db.VarChar(50)
  idEmpresa        Int?               @map("id_empresa")
  dataDesligamento DateTime           @map("data_desligamento") @db.Date
  tipo             TipoDesligamento
  motivo           MotivoDesligamento
  observacao       String?
  registradoPor    String?            @map("registrado_por") @db.VarChar(50)
  dataRegistro     DateTime           @default(now()) @map("data_registro")

  colaborador Colaborador @relation(fields: [opsId], references: [opsId])
  empresa     Empresa?    @relation(fields: [idEmpresa], references: [idEmpresa])

  @@index([opsId])
  @@index([idEmpresa])
  @@index([dataDesligamento])
  @@map("desligamento")
}

model Regional {
  idRegional  Int      @id @default(autoincrement()) @map("id_regional")
  nome        String   @unique @db.VarChar(100)
  codigo      String?  @db.VarChar(20)
  ativo       Boolean  @default(true)
  dataCriacao DateTime @default(now()) @map("data_criacao")

  estacoes Estacao[]

  @@map("regional")
}

model Treinamento {
  idTreinamento Int @id @default(autoincrement()) @map("id_treinamento")

  // cabeçalho (igual planilha)
  dataTreinamento DateTime @map("data_treinamento") @db.Date
  processo        String   @db.VarChar(120)
  tema            String   @db.VarChar(200)
  soc             String   @db.VarChar(50)

  // responsável
  liderResponsavelOpsId String @map("lider_responsavel_ops_id") @db.VarChar(50)

  // status e evidência
  status        StatusTreinamento @default(ABERTO)
  ataPdfUrl     String?           @map("ata_pdf_url") @db.VarChar(500)
  ataPdfNome    String?           @map("ata_pdf_nome") @db.VarChar(200)
  ataPdfMime    String?           @map("ata_pdf_mime") @db.VarChar(100)
  ataPdfSize    Int?              @map("ata_pdf_size")
  finalizadoAt  DateTime?         @map("finalizado_em")
  finalizadoPor String?           @map("finalizado_por") @db.VarChar(50)

  // auditoria
  criadoPor       String?  @map("criado_por") @db.VarChar(50)
  dataCriacao     DateTime @default(now()) @map("data_criacao")
  dataAtualizacao DateTime @default(now()) @updatedAt @map("data_atualizacao")

  // relations
  liderResponsavel Colaborador               @relation("TreinamentoLider", fields: [liderResponsavelOpsId], references: [opsId])
  participantes    TreinamentoParticipante[]
  setores          TreinamentoSetor[]

  @@index([dataTreinamento])
  @@index([soc])
  @@index([status])
  @@index([liderResponsavelOpsId])
  @@map("treinamento")
}

model TreinamentoParticipante {
  idTreinamentoParticipante Int @id @default(autoincrement()) @map("id_treinamento_participante")

  idTreinamento Int    @map("id_treinamento")
  opsId         String @map("ops_id") @db.VarChar(50)

  // para seleção/ata (não depende de CPF ser unique no banco)
  cpf String? @map("cpf") @db.VarChar(14)

  // controle
  presente   Boolean @default(true)
  observacao String?

  // auditoria
  adicionadoEm  DateTime @default(now()) @map("adicionado_em")
  adicionadoPor String?  @map("adicionado_por") @db.VarChar(50)

  treinamento Treinamento @relation(fields: [idTreinamento], references: [idTreinamento])
  colaborador Colaborador @relation(fields: [opsId], references: [opsId])

  @@unique([idTreinamento, opsId])
  @@index([opsId])
  @@index([idTreinamento])
  @@map("treinamento_participante")
}

// ✅ Treinamento pode valer para 1+ setores (mapeia "em quais setores" do teu requisito)
model TreinamentoSetor {
  idTreinamentoSetor Int @id @default(autoincrement()) @map("id_treinamento_setor")

  idTreinamento Int @map("id_treinamento")
  idSetor       Int @map("id_setor")

  treinamento Treinamento @relation(fields: [idTreinamento], references: [idTreinamento])
  setor       Setor       @relation(fields: [idSetor], references: [idSetor])

  @@unique([idTreinamento, idSetor])
  @@index([idSetor])
  @@index([idTreinamento])
  @@map("treinamento_setor")
}

enum StatusTreinamento {
  ABERTO
  FINALIZADO
  CANCELADO
}

enum TipoOcorrencia {
  TIPICA
  TRAJETO
}

enum Lateralidade {
  DIREITA
  ESQUERDA
  BILATERAL
  NAO_APLICAVEL
}

enum UserRole {
  ADMIN
  GESTAO
  LIDERANCA
  OPERACAO
}

enum StatusColaborador {
  ATIVO
  INATIVO
  AFASTADO
  FERIAS
}

enum StatusAusencia {
  ATIVO
  FINALIZADO
  CANCELADO
}

enum StatusAtestado {
  ATIVO
  FINALIZADO
  CANCELADO
}

enum TipoMedida {
  ADVERTENCIA
  SUSPENSAO
  ORIENTACAO
  OUTRA
}

enum TipoDesligamento {
  VOLUNTARIO
  INVOLUNTARIO
}

enum MotivoDesligamento {
  PEDIDO_COLABORADOR
  JUSTA_CAUSA
  SEM_JUSTA_CAUSA
  TERMINO_CONTRATO
  PERFORMANCE
  OUTRO
}
